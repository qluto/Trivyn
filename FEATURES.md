# FEATURES.md

Tria macOS アプリケーションの全機能一覧です。

## 概要

Tria は「Three Wins」生産性メソッドを実装した macOS メニューバーアプリです。日次・週次・月次の各タイムフレームで最大3つの目標を設定・管理できます。

---

## 1. 目標管理（コア機能）

### 目標の作成
- 3つの期間（日次・週次・月次）で目標を追加
- 各期間につき最大3つの目標（「Three Wins」メソッド）
- リアルタイムバリデーションで3つを超える追加を防止

### 目標の完了・状態管理
- 目標の完了/未完了の切り替え
- 完了した目標には取り消し線を表示
- 完了数/総数を示す進捗インジケーター
- 振り返り用の完了率計算

### 目標の編集・削除
- 目標タイトルの編集
- ホバー時に表示される削除ボタンでワンクリック削除

---

## 2. データ永続化

### ローカルストレージ
- UserDefaults に JSON エンコードで目標を保存
- フローティングウィンドウの位置を保存
- 設定（言語、週の開始日）を保存
- 振り返りの洞察を期間ごとに保存

### iCloud サポート（将来対応準備済み）
- iCloud 利用可能性の検出を実装済み
- iCloud コンテナパスの設定準備済み

---

## 3. ウィンドウ管理

### メニューバー統合
- システムメニューバーに三角形アイコン（SF Symbol）を表示
- 左クリックでポップオーバーの表示/非表示を切り替え
- 右クリックでコンテキストメニューを表示

### ポップオーバーウィンドウ
- 300x340 ポイントの固定サイズ
- フォーカス外で自動的に閉じる挙動
- アニメーションサポート

### フローティングウィンドウ（付箋スタイル）
- 枠なしの NSPanel でフローティングレベル
- ウィンドウ背景でドラッグ移動可能
- 目標数に応じた動的リサイズ（200x60〜300x400）
- 透明背景とマテリアルブラー効果
- 角丸、シャドウ、ボーダー
- 全スペースおよびフルスクリーンで利用可能
- 位置の永続化（アプリ再起動後も位置を復元）
- ホバーで表示される閉じるボタン（×マーク）

---

## 4. UI コンポーネント

### メニューバーポップオーバー
- **ヘッダー**: アプリタイトル + 3レベルの進捗インジケーター
- **目標リスト**: スクロール可能なリスト
- **レベル進捗インジケーター**: 各レベルの完了状況を示す3つの色付きドット（タップでレベル切り替え）
- **目標追加フィールド**: 「+」アイコン付きインライン入力
- **フッター**: フローティングウィンドウボタン、振り返りメニュー、設定ボタン、履歴ボタン
- **紙吹雪アニメーション**: 目標完了時の祝福エフェクト

### フローティングウィンドウ
- **レベル切り替え**: 日次/週次/月次を切り替える3つのボタン
- **番号付き目標行**: 1-2-3の番号で目標を表示
- **目標完了インジケーター**: 完了時に塗りつぶされる番号付き円
- **目標追加フィールド**: 次の番号プレースホルダー + テキスト入力
- **空状態**: 目標がない場合のコンテキストメッセージ

### 色分けされたレベル
- **日次**: オレンジ（緊急性を表現）
- **週次**: パープル（計画を表現）
- **月次**: ティール（長期ビジョンを表現）

---

## 5. 履歴・分析機能

### カレンダーベースの履歴ビュー
- 前月/翌月ナビゲーション
- 日付と目標完了ドットを表示するカレンダーグリッド
- 左側に週・月の目標インジケータードット
- 今日の日付を太字・アクセントカラーで強調
- レベルごとの色分けドット

### 選択と詳細表示
- 日/週/月をクリックして詳細を表示
- 選択期間の目標と完了状態を表示
- 完了メトリクスを表示
- 過去の期間も閲覧可能

---

## 6. 振り返り機能

### 振り返りインターフェース
- **週次振り返り**: 週末の週目標振り返り
- **月次振り返り**: 月末の月目標振り返り
- 完了率を示す達成リング（0/3〜3/3）
- 完了状態付きの目標リスト表示
- 洞察/学びを入力する3つのテキストフィールド
- 完了率に応じた励ましメッセージ:
  - 100%: 完全達成メッセージ
  - 67%以上: 「順調」メッセージ
  - 34%以上: 「進捗あり」メッセージ
  - 34%未満: 励ましメッセージ
  - 目標なし: 空状態メッセージ

### 振り返りの永続化
- 期間をキーにして UserDefaults に洞察を保存
- ビューを開いた時に既存の洞察を読み込み
- 保存時に紙吹雪アニメーション

---

## 7. 通知・リマインダー

### 週次リマインダー（月曜日）
- 週目標が設定されているかチェック
- 未設定: 目標設定を促す通知
- 設定済み: 未完了目標数のリマインダー
- 同一週内の重複通知を防止

### 月次リマインダー（毎月1日）
- 月目標が設定されているかチェック
- 未設定: 目標設定を促す通知
- 設定済み: 未完了目標数のリマインダー
- 同一月内の重複通知を防止

### 振り返りリマインダー
- **週次（日曜 17〜19時）**: 週目標の振り返りを促す
- **月次（月末日 17〜19時）**: 月目標の振り返りを促す
- 完了状況に応じたメッセージ:
  - 全完了: お祝いメッセージ
  - 一部完了: 振り返りを促す

### 通知システム
- アラート、サウンド、バッジの許可リクエスト
- サンドボックス/非サンドボックス環境での安全な処理
- 1時間ごとの定期チェック（設定可能）
- アプリ起動時の即時チェック

---

## 8. 設定・ローカライゼーション

### 言語設定
- 3つのオプション: システム（デフォルト）、英語、日本語
- i18next + react-i18next による多言語対応
- 言語変更で UI を即時更新
- SQLite (settings テーブル) に保存
- システム言語に基づく自動検出（日本語/英語）

### 週の開始日設定
- 各曜日を選択する7つのボタン
- 週の開始日を設定可能（カレンダー計算に影響）
- 設定変更でカレンダーを再計算
- 履歴ビューのカレンダーグリッドに反映

### 外観
- ライト/ダークモード対応
- カラースキームに適応する UI
- すりガラス風マテリアル効果（ultraThinMaterial）

---

## 9. 時間・期間の処理

### 期間検出
- **日次**: 同一カレンダー日のマッチング
- **週次**: 同一年週のマッチング（週開始設定を尊重）
- **月次**: 同一年月のマッチング

### カレンダー統合
- AppSettings 経由で週開始日を設定可能
- 週開始日を上書きしたシステムカレンダー
- 複数ロケールのサポート

### 日付変更の処理
- システムの NSCalendarDayChanged 通知を監視
- 真夜中に UI を自動更新
- 日をまたいでも目標状態を保持

---

## 10. アニメーション・視覚効果

### 紙吹雪アニメーションシステム
- 祝福時に35個のパーティクル
- 重力を含む物理シミュレーション（350 units/s²）
- ランダムな形状: 長方形、円、三角形
- パーティクルごとの独立した回転と回転速度
- カラーパレット: 6色の調和した色合い（青、紫、ティール、ラベンダー、コーンフラワー）
- 時間差のある遅延（パーティクルごとに0〜0.15秒）
- 放物線軌道の物理演算
- 画面端でのフェードイン/フェードアウト
- 合計2秒間の表示

### UI アニメーション
- レベル切り替え: 0.2秒の easeInOut
- ボタン/行のホバー効果: 0.1〜0.15秒の easeInOut
- ボタン押下: 0.2秒のスプリングアニメーション

---

## 11. キーボード・入力処理

### テキスト入力
- ポップオーバーとフローティングウィンドウ両方で目標作成用 TextField
- Enter キーで送信
- ローカライズされたプレースホルダーテキスト
- 空白のトリミングと空入力のバリデーション

### キーボードショートカット
- フローティングウィンドウ表示: F キー
- アプリ終了: Q キー
- 右クリックメニューのコンテキストショートカット

---

## 12. コンテキストメニュー

### 右クリックメニュー
- フローティングウィンドウを表示（F キー相当）
- アプリを終了（Q キー相当）
- ステータスバー右クリックで表示

---

## 13. 状態管理

### Observable オブジェクト
- **GoalStore**: 目標と選択レベルを @Published で管理するメインの状態コンテナ
- **AppSettings**: 週開始日と言語を @Published で管理する永続設定
- **ReminderService**: 通知スケジューリングを管理

### リアクティブ更新
- 目標配列の変更で UI を更新
- 選択レベルの変更でフィルタリングされた目標を表示
- 設定変更で通知をトリガー
- 日付変更で自動更新
- SwiftUI ビューへの環境オブジェクト伝播

---

## 14. アクセシビリティ・ローカライゼーション

### 多言語対応（i18next + react-i18next）
- 翻訳ファイルによる完全な国際化対応（`src/i18n/locales/`）
- 日本語（ja.json）と英語（en.json）の翻訳を提供
- ローカライゼーションキー（完全カバー）:
  - 目標レベル名（日次、週次、月次）
  - 曜日名（フル）
  - ナビゲーション項目（目標、振り返り、履歴、設定）
  - 目標関連テキスト（空状態、追加プレースホルダー、完了表示）
  - 振り返りタイトルとメッセージ
  - 設定ラベルと説明
  - 通知ラベル
  - アプリケーション情報
- settingsStore との統合による言語切り替え
- システム言語の自動検出とフォールバック

---

## 15. 拡張機能（将来対応準備済み）

### 目標階層サポート
- 目標関係のためのオプショナル parentGoalId フィールド
- 階層的な目標追跡の基盤
- 親子目標の整理（UI は未実装）

### 目標メモ
- Goal モデルにオプショナル note フィールド
- 詳細な目標説明のための将来拡張

### 目標タイムスタンプ
- 作成タイムスタンプ
- 完了タイムスタンプ
- 期間開始日
- 履歴追跡と分析を可能に

---

## 16. アプリライフサイクル

### 起動シーケンス
1. TriaApp が AppDelegate で初期化
2. StatusBarController がメニューバーアイコンを作成
3. FloatingWindowController がフローティングパネルを初期化（非表示）
4. ReminderService が初期化して通知をチェック
5. Dock アイコンを非表示（アクセサリアクティベーションポリシー）

### シャットダウン
- ウィンドウ位置を保存
- 目標を自動的に永続化
- 通知オブザーバーをクリーンアップ

---

## 統計情報

| 項目 | 値 |
|------|-----|
| Swift ソースファイル | 16 ファイル（5 ディレクトリに整理） |
| ビュー（UI コンポーネント） | 6 |
| サービス（ウィンドウ管理、ストレージ、リマインダー） | 4 |
| モデル（Goal, AppSettings） | 2 |
| ビューモデル（GoalStore） | 1 |
| アプリファイル（エントリポイント、デリゲート） | 2 |
| 目標レベル（色分け） | 3 |
| 振り返りテキストフィールド（週次・月次） | 各3個 |
| 言語オプション（システム、英語、日本語） | 3 |
| 週開始日オプション | 7（各曜日） |
| 紙吹雪パーティクル数 | 35 |
| 期間あたりの最大目標数 | 3 |
